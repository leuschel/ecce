% Module for testing optimized versions of database access libraries.
:- module(test,[main/0,p/2,r/2],[assertions,persdb_mysql_op,det_hook]).

%:- use_module(library('ciaopp/props'),[ground/1]).
:- use_module(library(prolog_sys),[statistics/2]).
:- set_prolog_flag(multi_arity_warnings,off).
this(noopt).

sql_persistent_location(db, db(optdb, clip, '2by4LOG', localhost:0)).

:- true pred p(A,B):: string * string + persistent(db,p(field1,field2)).
% :- sql_persistent(
%         p(string, string),
%         p(field1, field2),
%         db).             

:- true pred q(A,B):: string * string + persistent(db,q(field3,field4)).
% :- sql_persistent(
%         q(string, string),
%         q(field3, field4),
%         db).              

:- true pred r(A,B):: string * string + persistent(db,r(field5,field6)).
% :- sql_persistent(
%         r(string, string),
%         r(field5, field6),
%         db).              

main:-
	this(M),
 	statistics(walltime,_),
 	traverse_predicate,
 	statistics(walltime,[_,T1]),
 	display(results(M,traverse_predicate,T1)),display('.'),nl,
%
	statistics(walltime,_),
	key_ground_info,
	statistics(walltime,[_,T2]),
	display(results(M,key_ground_info,T2)),display('.'),nl,
%
	statistics(walltime,_),
	nokey_ground_info,
	statistics(walltime,[_,T3]),
	display(results(M,nokey_ground_info,T3)),display('.'),nl,
%
 	statistics(walltime,_),
 	group_traverse,
 	statistics(walltime,[_,T4]),
 	display(results(M,group_traverse,T4)),display('.'),nl,
%
	statistics(walltime,_),
	group_first_ground_info,
	statistics(walltime,[_,T5]),
	display(results(M,group_first_ground_info,T5)),display('.'),nl,
%
 	statistics(walltime,_),
 	group_second_ground_info,
 	statistics(walltime,[_,T6]),
 	display(results(M,group_second_ground_info,T6)),display('.'),nl,
%
  	statistics(walltime,_),
  	group_asymmetric,
  	statistics(walltime,[_,T7]),
  	display(results(M,group_asymmetric,T7)),display('.'),nl,
% Next test slows down with store_result
  	statistics(walltime,_),
  	group_unrelated,
  	statistics(walltime,[_,T8]),
  	display(results(M,group_unrelated,T8)),display('.'),nl,
% Next test breaks with use_result
  	statistics(walltime,_),
  	recursive_key_ground_info,
  	statistics(walltime,[_,T9]),
  	display(results(M,recursive_key_ground_info,T9)),display('.'),nl,
	true.

traverse_predicate:-
	p(X,Y),
%	display(' p'(X,Y)),nl,
	fail.
traverse_predicate.

key_ground_info:-
	random_list(L),
	member(X,L),
	ground(X),
	p(X,_Y),
%	display(' p'(X,_Y)),nl,
	fail.
key_ground_info.

nokey_ground_info:-
	random_list(L),
	member(Y,L),
	ground(Y),
	p(_X,Y),
%	display(' p'(_X,Y)),nl,
	fail.
nokey_ground_info.

group_traverse:-
	p(_X,Y),
	q(Y,_Z),
%	display(' p'(_X,Y)),display(',q'(Y,_Z)),nl,
	fail.
group_traverse.

group_first_ground_info:-
	random_list(L),
	member(X,L),
	ground(X),
	p(X,Y),
	q(Y,_Z),
%	display(' p'(X,Y)),display(',q'(Y,_Z)),nl,
	fail.
group_first_ground_info.

group_second_ground_info:-
	random_list(L),
	member(Y,L),
	ground(Y),
	p(_X,Y),
	q(Y,_Z),
%	display(' p'(_X,Y)),display(',q'(Y,_Z)),nl,
	fail.
group_second_ground_info.

group_asymmetric:-
%	random_list(L),
%	member(X,L),
%	ground(X),
	p(_X,Y),
	r(Y,_Z),
%	display(' p'(_X,Y)),display(',r'(Y,_Z)),nl,
	fail.
group_asymmetric.

group_unrelated:-
	p(_X,_Y),
	qq,
	fail.
group_unrelated.

qq:-	q(_U,_V),!.

recursive_key_ground_info:-
	random_list(L),
	rec(L).

rec([]).
rec([X|Xs]):-
	ground(X),
	p(X,_Y),
%	display(' p'(_X,_Y)),nl,
	rec(Xs).


random_list(['613','525','293','770','284','920','526','664','65','64','903','540','513','40','931','739','688','881','229','687','658','924','685','216','148','432','787','227','557','907','496','936','750','233','153','794','75','522','798','968','94','79','462','756','1000','126','871','924','164','820','580','100','305','878','36','926','980','984','164','77','630','317','75','652','281','114','945','848','345','234','482','183','414','638','610','329','921','258','261','94','577','289','330','4','189','919','122','775','862','549','910','577','865','849','181','140','839','222','139','932','837','335','609','73','364','92','584','762','884','208','830','327','985','137','784','115','50','708','866','383','810','54','693','590','596','889','610','597','71','170','827','879','660','779','309','613','783','402','231','155','381','738','553','810','646','844','519','719','153','686','701','6','656','342','654','187','829','192','869','933','552','553','815','996','875','760','263','167','874','612','539','33','833','490','815','453','248','718','583','996','641','220','738','851','900','537','950','968','781','258','332','555','478','917','866','200','677','561','19','924','888','448','640','293','900','273','866','925','168','177','947','120','916','71','437','913','35','754','36','662','890','51','699','313','810','54','245','59','57','257','585','927','730','634','932','523','680','270','215','684','853','668','251','515','532','737','44','488','821','79','924','245','93','167','778','737','97','102','810','278','761','846','457','324','82','660','583','529','769','515','453','434','127','781','911','48','928','597','540','578','790','98','748','832','517','579','756','144','845','667','889','271','658','507','143','645','674','813','591','775','881','360','648','870','806','367','600','433','461','225','302','481','859','185','289','688','960','862','537','829','406','155','348','641','542','192','237','350','344','810','522','360','684','141','601','870','314','533','959','54','40','220','74','460','564','673','476','931','901','922','821','5','628','37','873','676','638','997','100','292','381','890','177','926','276','829','453','462','387','188','918','616','502','651','521','676','789','335','244','418','778','145','524','542','236','477','942','267','449','587','972','985','516','741','585','324','788','428','706','8','523','168','557','194','728','679','722','646','785','382','855','982','907','155','268','479','268','574','664','986','128','61','770','770','801','449','36','350','818','146','341','926','68','325','889','488','801','548','375','68','7','47','170','282','539','207','765','482','929','769','990','718','15','648','388','35','37','430','564','255','651','90','498','944','750','805','597','927','341','214','614','547','60','322','614','474','110','284','480','624','486','55','48','481','1000','993','494','541','562','120','471','265','591','947','277','328','907','610','363','506','252','216','941','489','179','626','303','318','957','698','166','844','789','47','99','944','575','484','213','322','932','512','327','968','382','845','684','807','822','91','120','161','428','863','955','881','268','418','649','917','920','823','471','651','411','848','909','165','102','932','976','166','14','847','631','749','45','204','31','348','244','840','296','38','931','928','910','145','49','272','729','340','928','963','96','736','731','991','678','896','574','688','404','736','530','417','145','759','462','286','577','580','134','534','819','919','763','258','551','689','944','45','331','730','205','850','402','591','406','527','848','942','496','914','931','78','772','156','989','733','673','385','449','999','566','972','133','813','269','52','850','608','369','464','622','48','591','653','823','508','234','849','294','65','75','254','681','127','747','529','207','451','646','241','235','193','87','48','888','878','66','305','200','120','529','49','727','153','981','33','816','566','131','804','651','745','339','115','198','333','50','555','298','924','675','784','445','744','727','283','289','811','153','514','13','180','63','388','308','803','906','432','947','581','138','268','715','817','690','530','671','162','558','157','882','408','518','657','567','976','165','424','565','738','457','735','751','566','568','64','858','853','483','693','63','733','970','487','102','504','223','929','785','346','771','940','261','253','570','781','860','973','542','132','481','45','559','772','250','560','766','724','289','942','375','651','504','901','331','894','95','154','1','420','756','781','434','976','660','54','940','176','735','159','579','477','897','397','748','201','315','853','541','666','171','428','90','660','37','553','102','778','734','970','907','298','926','224','167','416','23','928','306','893','846','745','66','704','57','872','350','805','89','744','434','330','860','114','751','807','836','938','892','430','523','76','388','383','287','265','733','713','132','295','96','378','887','687','483','331','102','148','272','562','763','308','525','275','670','460','453','483','489','362','532','520','403','568','396','176','171','115','719','115','597','261','486','157','961','382','749','165','776','854','961','860','858','480','1000','88','204','799','356','365','187','353','383','680','811','172','939','282','317','760','727','814','281','614','970','308','11','828','922','70','126','49','700','935','233','595','108','975','995','523','924','386','259','927','69','496','378','654','606','550','245','418','882','918','139','515','352','662','272','103','226','765','770','940','209','809','336','898','469','44','145','697','84','565','66','656','831','968','721','695','441','201','393','900','638','745','737','963','87','379','942','1','321','673','994','494','981','790','820','538','988','315','215','772','550','615','623','404','926','911','52','790','325','51','866','408']).
